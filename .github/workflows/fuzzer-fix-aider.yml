name: Fuzzer Fix (Aider)
run-name: "Fuzzer Fix #${{ github.run_number }} (${{ inputs.model }})"

on:
  workflow_dispatch:
    inputs:
      model:
        description: 'Model'
        type: choice
        default: 'claude-opus-4-5'
        options:
          - claude-opus-4-5
          - claude-sonnet-4-5
          - gpt-4.1
          - o3
          - gemini-2.5-pro

jobs:
  fuzzer-fix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Set up bash-oracle
        run: |
          mkdir -p ~/source/bash-oracle
          aws s3 cp s3://ldayton-parable/bash-oracle ~/source/bash-oracle/bash-oracle
          chmod +x ~/source/bash-oracle/bash-oracle

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'
          allow-prereleases: true

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install just
        uses: extractions/setup-just@v2

      - name: Install dependencies
        run: uv sync --frozen

      - name: Determine API key
        id: api-key
        run: |
          case "${{ inputs.model }}" in
            claude-*)
              echo "env_name=ANTHROPIC_API_KEY" >> $GITHUB_OUTPUT
              echo "env_value=${{ secrets.ANTHROPIC_API_KEY }}" >> $GITHUB_OUTPUT
              ;;
            gpt-*|o3*)
              echo "env_name=OPENAI_API_KEY" >> $GITHUB_OUTPUT
              echo "env_value=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_OUTPUT
              ;;
            gemini-*)
              echo "env_name=GEMINI_API_KEY" >> $GITHUB_OUTPUT
              echo "env_value=${{ secrets.GEMINI_API_KEY }}" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Generate fuzz ID
        id: fuzz
        run: echo "id=$(openssl rand -hex 16)" >> $GITHUB_OUTPUT

      - name: Run fuzzer
        id: fuzzer
        run: |
          cd tools/fuzzer
          set +e
          output=$(uv run fuzzer --character --both-succeed --stop-after 1 -n 100000 -v 2>&1)
          exit_code=$?
          set -e
          echo "$output"
          echo "$output" > ../../.fuzzer-output.txt
          if echo "$output" | grep -q "Stopped after finding"; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Combine prompts
        if: steps.fuzzer.outputs.found == 'true'
        run: |
          {
            echo "# Fuzzer Fix Task"
            echo ""
            echo "FUZZ_ID: ${{ steps.fuzz.outputs.id }}"
            echo ""
            echo "## Fuzzer Output"
            echo ""
            echo '```'
            cat .fuzzer-output.txt
            echo '```'
            echo ""
            cat tools/fuzzer/prompts/fuzzer-fix-base.md
            echo ""
            cat tools/fuzzer/prompts/fuzzer-fix-workflow.md
          } > .aider-prompt.md

      - name: Run Aider
        if: steps.fuzzer.outputs.found == 'true'
        id: aider
        continue-on-error: true
        uses: mirrajabi/aider-github-action@v1.1.0
        timeout-minutes: 30
        with:
          api_key_env_name: ${{ steps.api-key.outputs.env_name }}
          api_key_env_value: ${{ steps.api-key.outputs.env_value }}
          branch: ${{ github.ref_name }}
          model: ${{ inputs.model }}
          aider_args: '--yes --read .aider-prompt.md --message "Follow the instructions in the prompt file."'

      - name: Check for Aider errors
        if: steps.fuzzer.outputs.found == 'true'
        run: |
          if [ -f .aider.chat.history.md ]; then
            if grep -qiE '(BadRequestError|credit balance|invalid.*api.?key|authentication|unauthorized|rate.?limit)' .aider.chat.history.md; then
              echo "::error::Aider encountered an API error"
              grep -iE '(BadRequestError|credit balance|invalid.*api.?key|authentication|unauthorized|rate.?limit)' .aider.chat.history.md
              exit 1
            fi
          fi
          if [ "${{ steps.aider.outcome }}" = "failure" ]; then
            echo "::error::Aider step failed"
            exit 1
          fi

      - name: Verify fix
        if: steps.fuzzer.outputs.found == 'true'
        run: |
          just fmt --fix
          just lint --fix
          just check

      - name: Job summary
        if: always()
        run: |
          echo "## Fuzzer Fix #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Trigger** | ![](https://img.shields.io/badge/manual-blue?style=flat-square&logo=githubactions) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered by** | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Model** | ${{ inputs.model }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Discrepancy found** | ${{ steps.fuzzer.outputs.found }} |" >> $GITHUB_STEP_SUMMARY

      - name: Create Pull Request
        if: hashFiles('pr-body.md') != ''
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Fix: parser bug found by fuzzer"
          branch: fix/fuzzer-aider-${{ github.run_id }}
          delete-branch: true
          title: "Fix: parser bug found by fuzzer"
          body-path: pr-body.md
