# Parable Roadmap

> **DO NOT EDIT THIS FILE.** This is a reference document maintained by hand.

## Test Suite Status

Parable is tested against bash-oracle (GNU Bash 5.3 patched with `--dump-ast`).

**Current:** 3,643 passed, 565 failed (87% pass rate)

Test corpora:
- **Oils bash corpus:** 2,495 tests
- **tree-sitter-bash corpus:** 93 tests
- **GNU Bash test corpus:** 78 tests
- **Parable hand-written tests:** 1,542 tests

Total: 4,208 tests (4,201 verified against oracle, 7 skipped due to binary content)

---

## Priorities

| Priority | Focus | Goal |
|----------|-------|------|
| P1 | Correctness | 100% test pass rate |
| P2 | Usability | Features for tool authors |
| P3 | Nice to have | Narrower use cases |

---

## P1: Correctness

Close the 565 failing tests before new features or refactoring.

---

## P2: Usability

Features that make Parable practical for tool authors.

### Position tracking

**Status:** Not implemented

AST nodes have no source location information. Required for:
- Syntax highlighters
- Linters with precise error locations
- IDEs
- Source maps

**Approach:** Store only byte offsets (16 bytes/node). Compute line/column lazily on demand from a line index. Make it opt-in to avoid overhead when not needed.

```python
ast = parse(code, track_positions=True)
node.start_offset  # always available
node.start_line    # computed on first access
node.start_col     # computed on first access
```

**Effort:** Medium

### JSON serialization

**Status:** Not implemented

```python
ast.to_dict()  # For JSON serialization
ast.to_json()  # Direct JSON output
```

**Effort:** Low

### Visitor pattern

**Status:** Not implemented

```python
class MyVisitor(Visitor):
    def visit_CommandSubstitution(self, node):
        print(f"Found command sub: {node}")

visitor = MyVisitor()
visitor.walk(ast)
```

**Effort:** Low

---

## P3: Nice to Have

Features with narrower use cases.

### Error recovery

**Status:** Not implemented

Parse incomplete/invalid input and return best-effort AST. Required for IDE use cases where code is often in an invalid state.

**Effort:** High (architectural change)

**Downside:** Partial ASTs can confuse downstream tools. Recovery heuristics are brittle.

### Comments preservation

**Status:** Not implemented

Attach comments to AST nodes. Required for formatters and doc generators.

**Effort:** Medium

**Downside:** Lexer rewrite. Ambiguous attachment (does comment belong to preceding or following node?).

### Source reconstruction

**Status:** Not implemented

Reconstruct source from AST: `ast.to_source()`. Required for formatters and refactoring tools.

**Effort:** Medium

**Downside:** Either preserve original whitespace (memory cost) or accept lossy reconstruction. Edge cases with heredocs and quotes.

---

## Internal Improvements

Refactoring phases to address issues identified in [quality.md](quality.md). Do these after P1 correctness is achieved.

### Phase 1: Add `match()`/`consume()` helpers
Extract common peek-advance patterns. Low risk, immediate readability wins.

### Phase 2: Extract `_parse_expansion()`
Unify `$`-expansion handling from 4 locations. Moderate complexity.

### Phase 3: Extract quote-aware scanner
Create `_scan_to_closer()` for balanced delimiter finding.

### Phase 4: Decompose `parse_word()`
Split into `_parse_single_quoted()`, `_parse_double_quoted()`, `_parse_unquoted_segment()`.

### Phase 5: Unify state management
Replace dynamic attributes with explicit fields. Add try/finally guards.

### Phase 6: Consolidate depth tracking
Replace multiple counters with nesting stack or unified approach.

### Phase 7: Extract formatters from AST
Move `to_sexp()` logic to separate visitor/formatter module.

### Phase 8: Standardize naming
Adopt consistent conventions for methods, parameters, abbreviations.

### Phase 9: Improve API surface
Add options, location info, clear public/private boundary.

---

## Issue Tracker

Issues from [quality.md](quality.md) with severity and effort estimates.

| #   | Category  | Issue                          | Severity | Effort |
| --- | --------- | ------------------------------ | -------- | ------ |
| 1   | Structure | `parse_word()` monolith        | High     | High   |
| 2   | Structure | Duplicated expansion logic     | High     | Medium |
| 3   | Structure | Missing helpers                | Medium   | Low    |
| 4   | Structure | Quote-scanning duplication     | Medium   | Medium |
| 5   | Control   | Keyword dispatch               | Low      | Low    |
| 6   | Control   | Manual peek-advance            | Medium   | Low    |
| 7   | Control   | Inconsistent error recovery    | Medium   | High   |
| 8   | Control   | Deep nesting                   | Low      | Medium |
| 9   | Control   | Repeated boundary checks       | Low      | Low    |
| 10  | Control   | Loop-accumulate patterns       | Low      | Low    |
| 11  | Control   | Inconsistent whitespace        | Low      | Low    |
| 12  | Perf      | Repeated scanning              | Medium   | High   |
| 13  | Perf      | Backtracking                   | Low      | Medium |
| 14  | State     | Dynamic `_pending_heredoc_end` | Medium   | Low    |
| 15  | State     | Parallel arithmetic cursor     | Medium   | Medium |
| 16  | State     | Multiple depth counters        | Low      | Medium |
| 17  | State     | No exception safety            | High     | Medium |
| 18  | AST       | `Word.to_sexp()` 480 lines     | High     | High   |
| 19  | AST       | Mixed data/presentation        | Medium   | High   |
| 20  | AST       | No visitor pattern             | Medium   | High   |
| 21  | AST       | Redundant `kind` field         | Low      | Low    |
| 22  | AST       | Inconsistent granularity       | Low      | High   |
| 23  | Naming    | Verbose method names           | Low      | Medium |
| 24  | Naming    | Inconsistent prefixes          | Low      | Low    |
| 25  | Naming    | Hungarian parameters           | Low      | Low    |
| 26  | Naming    | Abbreviation inconsistency     | Low      | Low    |
| 27  | Naming    | Boolean proliferation          | Medium   | Medium |
| 28  | Naming    | Unclear boundaries             | Low      | Medium |
| 29  | Naming    | No docstring conventions       | Low      | Medium |
| 30  | API       | Limited public API             | Medium   | Low    |
| 31  | API       | No parse options               | Medium   | Medium |
| 32  | API       | Offset-only errors             | Medium   | Low    |
| 33  | API       | No incremental parsing         | Low      | High   |
| 34  | API       | No location spans              | Medium   | Medium |
| 35  | API       | Coupled to string              | Low      | Medium |
| 36  | API       | No tree protocol               | Medium   | High   |
| 37  | API       | Mixed concerns                 | Low      | Low    |
| 38  | API       | No dialect handling            | Low      | Medium |

---

## Recommendations

### AST

Three approaches to address formatting concerns:

1. **Visitor pattern** (Crafting Interpreters style): Define `AstVisitor` interface, implement `SexpFormatter` visitor
2. **Match statements** (Python 3.10+): Use structural pattern matching in external functions
3. **Extract formatters**: Move `to_sexp()` to standalone module that imports AST types

Recommended: Option 3 (extract formatters) as lowest-risk first step.

### Naming

1. Drop `parse_` prefix for internal methods - context makes it obvious
2. Replace boolean flags with enums: `ParseMode.ARRAY_SUBSCRIPT` vs `in_array_subscript=True`
3. Standardize abbreviations: always `pos` or always `position`
4. Add docstrings to all public methods with Args/Returns sections

### API

1. Add `ParseOptions` dataclass for configuration
2. Include line/column in `ParseError`
3. Add `Node.span` property returning `(start, end)` positions
4. Split `parser.py` into `parser.py`, `errors.py`, `helpers.py`
5. Consider `ast.walk()` generator for tree traversal
