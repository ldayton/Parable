# Iteration 13: Arithmetic Expansion and Evaluation

# === Basic $((...)) arithmetic expansion ===

=== simple addition
echo $((1 + 2))
---
(command (word "echo") (word "$((1 + 2))" (arith "1 + 2")))

=== simple subtraction
echo $((5 - 3))
---
(command (word "echo") (word "$((5 - 3))" (arith "5 - 3")))

=== simple multiplication
echo $((4 * 3))
---
(command (word "echo") (word "$((4 * 3))" (arith "4 * 3")))

=== simple division
echo $((10 / 2))
---
(command (word "echo") (word "$((10 / 2))" (arith "10 / 2")))

=== modulo
echo $((10 % 3))
---
(command (word "echo") (word "$((10 % 3))" (arith "10 % 3")))

=== exponentiation
echo $((2 ** 8))
---
(command (word "echo") (word "$((2 ** 8))" (arith "2 ** 8")))

=== negative numbers
echo $((-5))
---
(command (word "echo") (word "$((-5))" (arith "-5")))

=== unary plus
echo $((+5))
---
(command (word "echo") (word "$((+5))" (arith "+5")))

# === No spaces ===

=== no spaces
echo $((1+2))
---
(command (word "echo") (word "$((1+2))" (arith "1+2")))

=== mixed spacing
echo $((1+ 2))
---
(command (word "echo") (word "$((1+ 2))" (arith "1+ 2")))

# === Variables in arithmetic ===

=== variable without dollar
echo $((x + 1))
---
(command (word "echo") (word "$((x + 1))" (arith "x + 1")))

=== variable with dollar
echo $(($x + 1))
---
(command (word "echo") (word "$(($x + 1))" (arith "$x + 1")))

=== braced variable
echo $((${x} + 1))
---
(command (word "echo") (word "$((${x} + 1))" (arith "${x} + 1")))

=== multiple variables
echo $((a + b))
---
(command (word "echo") (word "$((a + b))" (arith "a + b")))

# === Comparison operators ===

=== less than
echo $((1 < 2))
---
(command (word "echo") (word "$((1 < 2))" (arith "1 < 2")))

=== greater than
echo $((2 > 1))
---
(command (word "echo") (word "$((2 > 1))" (arith "2 > 1")))

=== less or equal
echo $((1 <= 2))
---
(command (word "echo") (word "$((1 <= 2))" (arith "1 <= 2")))

=== greater or equal
echo $((2 >= 1))
---
(command (word "echo") (word "$((2 >= 1))" (arith "2 >= 1")))

=== equality
echo $((1 == 1))
---
(command (word "echo") (word "$((1 == 1))" (arith "1 == 1")))

=== inequality
echo $((1 != 2))
---
(command (word "echo") (word "$((1 != 2))" (arith "1 != 2")))

# === Logical operators ===

=== logical and
echo $((1 && 1))
---
(command (word "echo") (word "$((1 && 1))" (arith "1 && 1")))

=== logical or
echo $((0 || 1))
---
(command (word "echo") (word "$((0 || 1))" (arith "0 || 1")))

=== logical not
echo $((!0))
---
(command (word "echo") (word "$((!0))" (arith "!0")))

# === Bitwise operators ===

=== bitwise and
echo $((5 & 3))
---
(command (word "echo") (word "$((5 & 3))" (arith "5 & 3")))

=== bitwise or
echo $((5 | 3))
---
(command (word "echo") (word "$((5 | 3))" (arith "5 | 3")))

=== bitwise xor
echo $((5 ^ 3))
---
(command (word "echo") (word "$((5 ^ 3))" (arith "5 ^ 3")))

=== bitwise not
echo $((~5))
---
(command (word "echo") (word "$((~5))" (arith "~5")))

=== left shift
echo $((1 << 4))
---
(command (word "echo") (word "$((1 << 4))" (arith "1 << 4")))

=== right shift
echo $((16 >> 2))
---
(command (word "echo") (word "$((16 >> 2))" (arith "16 >> 2")))

# === Assignment operators ===

=== simple assignment
echo $((x = 5))
---
(command (word "echo") (word "$((x = 5))" (arith "x = 5")))

=== add assign
echo $((x += 5))
---
(command (word "echo") (word "$((x += 5))" (arith "x += 5")))

=== subtract assign
echo $((x -= 5))
---
(command (word "echo") (word "$((x -= 5))" (arith "x -= 5")))

=== multiply assign
echo $((x *= 5))
---
(command (word "echo") (word "$((x *= 5))" (arith "x *= 5")))

=== divide assign
echo $((x /= 5))
---
(command (word "echo") (word "$((x /= 5))" (arith "x /= 5")))

=== modulo assign
echo $((x %= 5))
---
(command (word "echo") (word "$((x %= 5))" (arith "x %= 5")))

# === Increment/decrement ===

=== pre-increment
echo $((++x))
---
(command (word "echo") (word "$((++x))" (arith "++x")))

=== post-increment
echo $((x++))
---
(command (word "echo") (word "$((x++))" (arith "x++")))

=== pre-decrement
echo $((--x))
---
(command (word "echo") (word "$((--x))" (arith "--x")))

=== post-decrement
echo $((x--))
---
(command (word "echo") (word "$((x--))" (arith "x--")))

# === Ternary operator ===

=== ternary true
echo $((1 ? 10 : 20))
---
(command (word "echo") (word "$((1 ? 10 : 20))" (arith "1 ? 10 : 20")))

=== ternary false
echo $((0 ? 10 : 20))
---
(command (word "echo") (word "$((0 ? 10 : 20))" (arith "0 ? 10 : 20")))

=== ternary with expressions
echo $((x > 0 ? x : -x))
---
(command (word "echo") (word "$((x > 0 ? x : -x))" (arith "x > 0 ? x : -x")))

# === Comma operator ===

=== comma operator
echo $((x = 1, y = 2, x + y))
---
(command (word "echo") (word "$((x = 1, y = 2, x + y))" (arith "x = 1, y = 2, x + y")))

# === Parentheses for grouping ===

=== parentheses grouping
echo $(((1 + 2) * 3))
---
(command (word "echo") (word "$(((1 + 2) * 3))" (arith "(1 + 2) * 3")))

=== nested parentheses
echo $((((1 + 2)) * 3))
---
(command (word "echo") (word "$((((1 + 2)) * 3))" (arith "((1 + 2)) * 3")))

=== complex grouping
echo $(((a + b) * (c + d)))
---
(command (word "echo") (word "$(((a + b) * (c + d)))" (arith "(a + b) * (c + d)")))

# === In different contexts ===

=== arithmetic in assignment
x=$((1 + 2))
---
(command (word "x=$((1 + 2))" (arith "1 + 2")))

=== arithmetic in middle of word
echo prefix$((1+2))suffix
---
(command (word "echo") (word "prefix$((1+2))suffix" (arith "1+2")))

=== multiple arithmetic in word
echo $((1+2))$((3+4))
---
(command (word "echo") (word "$((1+2))$((3+4))" (arith "1+2") (arith "3+4")))

=== arithmetic in double quotes
echo "result: $((1 + 2))"
---
(command (word "echo") (word "\"result: $((1 + 2))\"" (arith "1 + 2")))

# === ((...)) arithmetic command ===

=== arithmetic command simple
((x = 5))
---
(arith-cmd "x = 5")

=== arithmetic command increment
((x++))
---
(arith-cmd "x++")

=== arithmetic command comparison
((x > 0))
---
(arith-cmd "x > 0")

=== arithmetic command in if
if ((x > 0)); then echo positive; fi
---
(if (arith-cmd "x > 0") (command (word "echo") (word "positive")))

=== arithmetic command in while
while ((i < 10)); do echo $i; ((i++)); done
---
(while (arith-cmd "i < 10") (list (command (word "echo") (word "$i" (param "i"))) (semi) (arith-cmd "i++")))

=== arithmetic command with semicolon
((x = 1)); echo $x
---
(list (arith-cmd "x = 1") (semi) (command (word "echo") (word "$x" (param "x"))))

# === Complex expressions ===

=== complex expression
echo $((a * b + c / d - e % f))
---
(command (word "echo") (word "$((a * b + c / d - e % f))" (arith "a * b + c / d - e % f")))

=== mixed operators
echo $((1 + 2 * 3 - 4 / 2))
---
(command (word "echo") (word "$((1 + 2 * 3 - 4 / 2))" (arith "1 + 2 * 3 - 4 / 2")))

=== chained comparisons via logical
echo $((a > 0 && a < 10))
---
(command (word "echo") (word "$((a > 0 && a < 10))" (arith "a > 0 && a < 10")))

# === Whitespace variations ===

=== extra whitespace
echo $((  1  +  2  ))
---
(command (word "echo") (word "$((  1  +  2  ))" (arith "  1  +  2  ")))

=== newline in arithmetic
echo $((1 +
2))
---
(command (word "echo") (word "$((1 +\n2))" (arith "1 +\n2")))

=== tabs
echo $((	1	+	2	))
---
(command (word "echo") (word "$((	1	+	2	))" (arith "	1	+	2	")))

# === Base conversion ===

=== hex number
echo $((0xFF))
---
(command (word "echo") (word "$((0xFF))" (arith "0xFF")))

=== octal number
echo $((0777))
---
(command (word "echo") (word "$((0777))" (arith "0777")))

=== binary number
echo $((2#1010))
---
(command (word "echo") (word "$((2#1010))" (arith "2#1010")))

=== base 36
echo $((36#z))
---
(command (word "echo") (word "$((36#z))" (arith "36#z")))

# === Empty and edge cases ===

=== just zero
echo $((0))
---
(command (word "echo") (word "$((0))" (arith "0")))

=== just variable
echo $((x))
---
(command (word "echo") (word "$((x))" (arith "x")))

=== nested arithmetic expansion
echo $((1 + $((2 + 3))))
---
(command (word "echo") (word "$((1 + $((2 + 3))))" (arith "1 + $((2 + 3))")))

# === Brutal edge cases ===

# Empty expression evaluates to 0
=== empty arithmetic
echo $(())
---
(command (word "echo") (word "$(())" (arith "")))

# Multiple spaces
=== only spaces
echo $((   ))
---
(command (word "echo") (word "$((   ))" (arith "   ")))

# Deeply nested parentheses
=== deeply nested parens
echo $(((((1+2)))))
---
(command (word "echo") (word "$(((((1+2)))))" (arith "(((1+2)))")))

# Negative number edge cases
=== double negative
echo $((--5))
---
(command (word "echo") (word "$((--5))" (arith "--5")))

=== negate negative
echo $((-(-5)))
---
(command (word "echo") (word "$((-(-5)))" (arith "-(-5)")))

=== subtract negative
echo $((1 - -2))
---
(command (word "echo") (word "$((1 - -2))" (arith "1 - -2")))

# Chained assignments
=== chained assignment
echo $((a = b = c = 5))
---
(command (word "echo") (word "$((a = b = c = 5))" (arith "a = b = c = 5")))

# Complex ternary
=== nested ternary
echo $((a ? b ? 1 : 2 : 3))
---
(command (word "echo") (word "$((a ? b ? 1 : 2 : 3))" (arith "a ? b ? 1 : 2 : 3")))

=== ternary with comma
echo $((a ? (b++, c) : d))
---
(command (word "echo") (word "$((a ? (b++, c) : d))" (arith "a ? (b++, c) : d")))

# Array subscript in arithmetic
=== array subscript
echo $((arr[0] + arr[1]))
---
(command (word "echo") (word "$((arr[0] + arr[1]))" (arith "arr[0] + arr[1]")))

=== array subscript expression
echo $((arr[i+1]))
---
(command (word "echo") (word "$((arr[i+1]))" (arith "arr[i+1]")))

=== complex array subscript
echo $((arr[arr[0]]))
---
(command (word "echo") (word "$((arr[arr[0]]))" (arith "arr[arr[0]]")))

# Bitwise operations
=== all bitwise ops
echo $((~a | b & c ^ d << 2 >> 1))
---
(command (word "echo") (word "$((~a | b & c ^ d << 2 >> 1))" (arith "~a | b & c ^ d << 2 >> 1")))

=== bitwise assign ops
echo $((x &= 0xFF, y |= 0x80, z ^= 0x01))
---
(command (word "echo") (word "$((x &= 0xFF, y |= 0x80, z ^= 0x01))" (arith "x &= 0xFF, y |= 0x80, z ^= 0x01")))

# Mixed base numbers
=== mixed bases
echo $((0xFF + 0777 + 2#1010))
---
(command (word "echo") (word "$((0xFF + 0777 + 2#1010))" (arith "0xFF + 0777 + 2#1010")))

=== base 64
echo $((64#_))
---
(command (word "echo") (word "$((64#_))" (arith "64#_")))

# Special variables in arithmetic
=== RANDOM in arithmetic
echo $((RANDOM % 100))
---
(command (word "echo") (word "$((RANDOM % 100))" (arith "RANDOM % 100")))

=== special params in arithmetic
echo $(($# + $?))
---
(command (word "echo") (word "$(($# + $?))" (arith "$# + $?")))

# Arithmetic command edge cases
=== empty arithmetic command
(())
---
(arith-cmd "")

=== arithmetic command with assignment chain
((a = b = 0))
---
(arith-cmd "a = b = 0")

=== arithmetic command multiple expressions
((a++, b--, c = a + b))
---
(arith-cmd "a++, b--, c = a + b")

=== arithmetic command in conditional
if ((1)); then echo yes; fi
---
(if (arith-cmd "1") (command (word "echo") (word "yes")))

=== arithmetic command zero is false
if ((0)); then echo yes; else echo no; fi
---
(if (arith-cmd "0") (command (word "echo") (word "yes")) (command (word "echo") (word "no")))

# NOTE: C-style for loop for ((init; cond; incr)) is a future feature

# Multiple arithmetic in one word
=== adjacent arithmetic expansions
echo $((1))$((2))$((3))
---
(command (word "echo") (word "$((1))$((2))$((3))" (arith "1") (arith "2") (arith "3")))

# Arithmetic with parameter expansion inside
=== param expansion in arithmetic
echo $((${x:-5} + 1))
---
(command (word "echo") (word "$((${x:-5} + 1))" (arith "${x:-5} + 1")))

=== complex param in arithmetic
echo $((${#arr[@]} - 1))
---
(command (word "echo") (word "$((${#arr[@]} - 1))" (arith "${#arr[@]} - 1")))

# Arithmetic command in pipeline
=== arithmetic command pipeline
((x++)) && echo incremented
---
(list (arith-cmd "x++") (and) (command (word "echo") (word "incremented")))

=== arithmetic command or
((x > 0)) || echo "not positive"
---
(list (arith-cmd "x > 0") (or) (command (word "echo") (word "\"not positive\"")))

# Real-world patterns
=== counter loop idiom
i=0; while ((i++ < 10)); do echo $i; done
---
(list (command (word "i=0")) (semi) (while (arith-cmd "i++ < 10") (command (word "echo") (word "$i" (param "i")))))

=== bounds check
((index >= 0 && index < ${#arr[@]})) && echo valid
---
(list (arith-cmd "index >= 0 && index < ${#arr[@]}") (and) (command (word "echo") (word "valid")))

=== flag toggle
((flag ^= 1))
---
(arith-cmd "flag ^= 1")

=== power of two check
(((n & (n - 1)) == 0))
---
(arith-cmd "(n & (n - 1)) == 0")

