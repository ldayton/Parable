# Iteration 13: Arithmetic Expansion and Evaluation

# === Basic $((...)) arithmetic expansion ===

=== simple addition
echo $((1 + 2))
---
(command (word "echo") (word "$((1 + 2))" (arith (binary-op "+" (number "1") (number "2")))))

=== simple subtraction
echo $((5 - 3))
---
(command (word "echo") (word "$((5 - 3))" (arith (binary-op "-" (number "5") (number "3")))))

=== simple multiplication
echo $((4 * 3))
---
(command (word "echo") (word "$((4 * 3))" (arith (binary-op "*" (number "4") (number "3")))))

=== simple division
echo $((10 / 2))
---
(command (word "echo") (word "$((10 / 2))" (arith (binary-op "/" (number "10") (number "2")))))

=== modulo
echo $((10 % 3))
---
(command (word "echo") (word "$((10 % 3))" (arith (binary-op "%" (number "10") (number "3")))))

=== exponentiation
echo $((2 ** 8))
---
(command (word "echo") (word "$((2 ** 8))" (arith (binary-op "**" (number "2") (number "8")))))

=== negative numbers
echo $((-5))
---
(command (word "echo") (word "$((-5))" (arith (unary-op "-" (number "5")))))

=== unary plus
echo $((+5))
---
(command (word "echo") (word "$((+5))" (arith (unary-op "+" (number "5")))))

=== no spaces
echo $((1+2))
---
(command (word "echo") (word "$((1+2))" (arith (binary-op "+" (number "1") (number "2")))))

=== mixed spacing
echo $((1+ 2))
---
(command (word "echo") (word "$((1+ 2))" (arith (binary-op "+" (number "1") (number "2")))))

=== variable without dollar
echo $((x + 1))
---
(command (word "echo") (word "$((x + 1))" (arith (binary-op "+" (var "x") (number "1")))))

=== variable with dollar
echo $(($x + 1))
---
(command (word "echo") (word "$(($x + 1))" (arith (binary-op "+" (param "x") (number "1")))))

=== braced variable
echo $((${x} + 1))
---
(command (word "echo") (word "$((${x} + 1))" (arith (binary-op "+" (param "x") (number "1")))))

=== multiple variables
echo $((a + b))
---
(command (word "echo") (word "$((a + b))" (arith (binary-op "+" (var "a") (var "b")))))

=== less than
echo $((1 < 2))
---
(command (word "echo") (word "$((1 < 2))" (arith (binary-op "<" (number "1") (number "2")))))

=== greater than
echo $((2 > 1))
---
(command (word "echo") (word "$((2 > 1))" (arith (binary-op ">" (number "2") (number "1")))))

=== less or equal
echo $((1 <= 2))
---
(command (word "echo") (word "$((1 <= 2))" (arith (binary-op "<=" (number "1") (number "2")))))

=== greater or equal
echo $((2 >= 1))
---
(command (word "echo") (word "$((2 >= 1))" (arith (binary-op ">=" (number "2") (number "1")))))

=== equality
echo $((1 == 1))
---
(command (word "echo") (word "$((1 == 1))" (arith (binary-op "==" (number "1") (number "1")))))

=== inequality
echo $((1 != 2))
---
(command (word "echo") (word "$((1 != 2))" (arith (binary-op "!=" (number "1") (number "2")))))

=== logical and
echo $((1 && 1))
---
(command (word "echo") (word "$((1 && 1))" (arith (binary-op "&&" (number "1") (number "1")))))

=== logical or
echo $((0 || 1))
---
(command (word "echo") (word "$((0 || 1))" (arith (binary-op "||" (number "0") (number "1")))))

=== logical not
echo $((!0))
---
(command (word "echo") (word "$((!0))" (arith (unary-op "!" (number "0")))))

=== bitwise and
echo $((5 & 3))
---
(command (word "echo") (word "$((5 & 3))" (arith (binary-op "&" (number "5") (number "3")))))

=== bitwise or
echo $((5 | 3))
---
(command (word "echo") (word "$((5 | 3))" (arith (binary-op "|" (number "5") (number "3")))))

=== bitwise xor
echo $((5 ^ 3))
---
(command (word "echo") (word "$((5 ^ 3))" (arith (binary-op "^" (number "5") (number "3")))))

=== bitwise not
echo $((~5))
---
(command (word "echo") (word "$((~5))" (arith (unary-op "~" (number "5")))))

=== left shift
echo $((1 << 4))
---
(command (word "echo") (word "$((1 << 4))" (arith (binary-op "<<" (number "1") (number "4")))))

=== right shift
echo $((16 >> 2))
---
(command (word "echo") (word "$((16 >> 2))" (arith (binary-op ">>" (number "16") (number "2")))))

=== simple assignment
echo $((x = 5))
---
(command (word "echo") (word "$((x = 5))" (arith (assign "=" (var "x") (number "5")))))

=== add assign
echo $((x += 5))
---
(command (word "echo") (word "$((x += 5))" (arith (assign "+=" (var "x") (number "5")))))

=== subtract assign
echo $((x -= 5))
---
(command (word "echo") (word "$((x -= 5))" (arith (assign "-=" (var "x") (number "5")))))

=== multiply assign
echo $((x *= 5))
---
(command (word "echo") (word "$((x *= 5))" (arith (assign "*=" (var "x") (number "5")))))

=== divide assign
echo $((x /= 5))
---
(command (word "echo") (word "$((x /= 5))" (arith (assign "/=" (var "x") (number "5")))))

=== modulo assign
echo $((x %= 5))
---
(command (word "echo") (word "$((x %= 5))" (arith (assign "%=" (var "x") (number "5")))))

=== pre-increment
echo $((++x))
---
(command (word "echo") (word "$((++x))" (arith (pre-incr (var "x")))))

=== post-increment
echo $((x++))
---
(command (word "echo") (word "$((x++))" (arith (post-incr (var "x")))))

=== pre-decrement
echo $((--x))
---
(command (word "echo") (word "$((--x))" (arith (pre-decr (var "x")))))

=== post-decrement
echo $((x--))
---
(command (word "echo") (word "$((x--))" (arith (post-decr (var "x")))))

=== ternary true
echo $((1 ? 10 : 20))
---
(command (word "echo") (word "$((1 ? 10 : 20))" (arith (ternary (number "1") (number "10") (number "20")))))

=== ternary false
echo $((0 ? 10 : 20))
---
(command (word "echo") (word "$((0 ? 10 : 20))" (arith (ternary (number "0") (number "10") (number "20")))))

=== ternary with expressions
echo $((x > 0 ? x : -x))
---
(command (word "echo") (word "$((x > 0 ? x : -x))" (arith (ternary (binary-op ">" (var "x") (number "0")) (var "x") (unary-op "-" (var "x"))))))

=== comma operator
echo $((x = 1, y = 2, x + y))
---
(command (word "echo") (word "$((x = 1, y = 2, x + y))" (arith (comma (comma (assign "=" (var "x") (number "1")) (assign "=" (var "y") (number "2"))) (binary-op "+" (var "x") (var "y"))))))

=== parentheses grouping
echo $(((1 + 2) * 3))
---
(command (word "echo") (word "$(((1 + 2) * 3))" (arith (binary-op "*" (binary-op "+" (number "1") (number "2")) (number "3")))))

=== nested parentheses
echo $((((1 + 2)) * 3))
---
(command (word "echo") (word "$((((1 + 2)) * 3))" (arith (binary-op "*" (binary-op "+" (number "1") (number "2")) (number "3")))))

=== complex grouping
echo $(((a + b) * (c + d)))
---
(command (word "echo") (word "$(((a + b) * (c + d)))" (arith (binary-op "*" (binary-op "+" (var "a") (var "b")) (binary-op "+" (var "c") (var "d"))))))

=== arithmetic in assignment
x=$((1 + 2))
---
(command (word "x=$((1 + 2))" (arith (binary-op "+" (number "1") (number "2")))))

=== arithmetic in middle of word
echo prefix$((1+2))suffix
---
(command (word "echo") (word "prefix$((1+2))suffix" (arith (binary-op "+" (number "1") (number "2")))))

=== multiple arithmetic in word
echo $((1+2))$((3+4))
---
(command (word "echo") (word "$((1+2))$((3+4))" (arith (binary-op "+" (number "1") (number "2"))) (arith (binary-op "+" (number "3") (number "4")))))

=== arithmetic in double quotes
echo "result: $((1 + 2))"
---
(command (word "echo") (word "\"result: $((1 + 2))\"" (arith (binary-op "+" (number "1") (number "2")))))

=== arithmetic command simple
((x = 5))
---
(arith-cmd (assign "=" (var "x") (number "5")))

=== arithmetic command increment
((x++))
---
(arith-cmd (post-incr (var "x")))

=== arithmetic command comparison
((x > 0))
---
(arith-cmd (binary-op ">" (var "x") (number "0")))

=== arithmetic command in if
if ((x > 0)); then echo positive; fi
---
(if (arith-cmd (binary-op ">" (var "x") (number "0"))) (command (word "echo") (word "positive")))

=== arithmetic command in while
while ((i < 10)); do echo $i; ((i++)); done
---
(while (arith-cmd (binary-op "<" (var "i") (number "10"))) (list (command (word "echo") (word "$i" (param "i"))) (semi) (arith-cmd (post-incr (var "i")))))

=== arithmetic command with semicolon
((x = 1)); echo $x
---
(list (arith-cmd (assign "=" (var "x") (number "1"))) (semi) (command (word "echo") (word "$x" (param "x"))))

=== complex expression
echo $((a * b + c / d - e % f))
---
(command (word "echo") (word "$((a * b + c / d - e % f))" (arith (binary-op "-" (binary-op "+" (binary-op "*" (var "a") (var "b")) (binary-op "/" (var "c") (var "d"))) (binary-op "%" (var "e") (var "f"))))))

=== mixed operators
echo $((1 + 2 * 3 - 4 / 2))
---
(command (word "echo") (word "$((1 + 2 * 3 - 4 / 2))" (arith (binary-op "-" (binary-op "+" (number "1") (binary-op "*" (number "2") (number "3"))) (binary-op "/" (number "4") (number "2"))))))

=== chained comparisons via logical
echo $((a > 0 && a < 10))
---
(command (word "echo") (word "$((a > 0 && a < 10))" (arith (binary-op "&&" (binary-op ">" (var "a") (number "0")) (binary-op "<" (var "a") (number "10"))))))

=== extra whitespace
echo $((  1  +  2  ))
---
(command (word "echo") (word "$((  1  +  2  ))" (arith (binary-op "+" (number "1") (number "2")))))

=== newline in arithmetic
echo $((1 +
2))
---
(command (word "echo") (word "$((1 +\n2))" (arith (binary-op "+" (number "1") (number "2")))))

=== tabs
echo $((	1	+	2	))
---
(command (word "echo") (word "$((	1	+	2	))" (arith (binary-op "+" (number "1") (number "2")))))

=== hex number
echo $((0xFF))
---
(command (word "echo") (word "$((0xFF))" (arith (number "0xFF"))))

=== octal number
echo $((0777))
---
(command (word "echo") (word "$((0777))" (arith (number "0777"))))

=== binary number
echo $((2#1010))
---
(command (word "echo") (word "$((2#1010))" (arith (number "2#1010"))))

=== base 36
echo $((36#z))
---
(command (word "echo") (word "$((36#z))" (arith (number "36#z"))))

=== just zero
echo $((0))
---
(command (word "echo") (word "$((0))" (arith (number "0"))))

=== just variable
echo $((x))
---
(command (word "echo") (word "$((x))" (arith (var "x"))))

=== nested arithmetic expansion
echo $((1 + $((2 + 3))))
---
(command (word "echo") (word "$((1 + $((2 + 3))))" (arith (binary-op "+" (number "1") (arith (binary-op "+" (number "2") (number "3")))))))

=== empty arithmetic
echo $(())
---
(command (word "echo") (word "$(())" (arith)))

=== only spaces
echo $((   ))
---
(command (word "echo") (word "$((   ))" (arith)))

=== deeply nested parens
echo $(((((1+2)))))
---
(command (word "echo") (word "$(((((1+2)))))" (arith (binary-op "+" (number "1") (number "2")))))

=== double negative
echo $((--5))
---
(command (word "echo") (word "$((--5))" (arith (unary-op "-" (unary-op "-" (number "5"))))))

=== double positive
echo $((++5))
---
(command (word "echo") (word "$((++5))" (arith (unary-op "+" (unary-op "+" (number "5"))))))

=== negate negative
echo $((-(-5)))
---
(command (word "echo") (word "$((-(-5)))" (arith (unary-op "-" (unary-op "-" (number "5"))))))

=== subtract negative
echo $((1 - -2))
---
(command (word "echo") (word "$((1 - -2))" (arith (binary-op "-" (number "1") (unary-op "-" (number "2"))))))

=== chained assignment
echo $((a = b = c = 5))
---
(command (word "echo") (word "$((a = b = c = 5))" (arith (assign "=" (var "a") (assign "=" (var "b") (assign "=" (var "c") (number "5")))))))

=== nested ternary
echo $((a ? b ? 1 : 2 : 3))
---
(command (word "echo") (word "$((a ? b ? 1 : 2 : 3))" (arith (ternary (var "a") (ternary (var "b") (number "1") (number "2")) (number "3")))))

=== ternary with comma
echo $((a ? (b++, c) : d))
---
(command (word "echo") (word "$((a ? (b++, c) : d))" (arith (ternary (var "a") (comma (post-incr (var "b")) (var "c")) (var "d")))))

=== array subscript
echo $((arr[0] + arr[1]))
---
(command (word "echo") (word "$((arr[0] + arr[1]))" (arith (binary-op "+" (subscript "arr" (number "0")) (subscript "arr" (number "1"))))))

=== array subscript expression
echo $((arr[i+1]))
---
(command (word "echo") (word "$((arr[i+1]))" (arith (subscript "arr" (binary-op "+" (var "i") (number "1"))))))

=== complex array subscript
echo $((arr[arr[0]]))
---
(command (word "echo") (word "$((arr[arr[0]]))" (arith (subscript "arr" (subscript "arr" (number "0"))))))

=== all bitwise ops
echo $((~a | b & c ^ d << 2 >> 1))
---
(command (word "echo") (word "$((~a | b & c ^ d << 2 >> 1))" (arith (binary-op "|" (unary-op "~" (var "a")) (binary-op "^" (binary-op "&" (var "b") (var "c")) (binary-op ">>" (binary-op "<<" (var "d") (number "2")) (number "1")))))))

=== bitwise assign ops
echo $((x &= 0xFF, y |= 0x80, z ^= 0x01))
---
(command (word "echo") (word "$((x &= 0xFF, y |= 0x80, z ^= 0x01))" (arith (comma (comma (assign "&=" (var "x") (number "0xFF")) (assign "|=" (var "y") (number "0x80"))) (assign "^=" (var "z") (number "0x01"))))))

=== mixed bases
echo $((0xFF + 0777 + 2#1010))
---
(command (word "echo") (word "$((0xFF + 0777 + 2#1010))" (arith (binary-op "+" (binary-op "+" (number "0xFF") (number "0777")) (number "2#1010")))))

=== base 64
echo $((64#_))
---
(command (word "echo") (word "$((64#_))" (arith (number "64#_"))))

=== RANDOM in arithmetic
echo $((RANDOM % 100))
---
(command (word "echo") (word "$((RANDOM % 100))" (arith (binary-op "%" (var "RANDOM") (number "100")))))

=== special params in arithmetic
echo $(($# + $?))
---
(command (word "echo") (word "$(($# + $?))" (arith (binary-op "+" (param "#") (param "?")))))

=== empty arithmetic command
(())
---
(arith-cmd)

=== arithmetic command with assignment chain
((a = b = 0))
---
(arith-cmd (assign "=" (var "a") (assign "=" (var "b") (number "0"))))

=== arithmetic command multiple expressions
((a++, b--, c = a + b))
---
(arith-cmd (comma (comma (post-incr (var "a")) (post-decr (var "b"))) (assign "=" (var "c") (binary-op "+" (var "a") (var "b")))))

=== arithmetic command in conditional
if ((1)); then echo yes; fi
---
(if (arith-cmd (number "1")) (command (word "echo") (word "yes")))

=== arithmetic command zero is false
if ((0)); then echo yes; else echo no; fi
---
(if (arith-cmd (number "0")) (command (word "echo") (word "yes")) (command (word "echo") (word "no")))

=== adjacent arithmetic expansions
echo $((1))$((2))$((3))
---
(command (word "echo") (word "$((1))$((2))$((3))" (arith (number "1")) (arith (number "2")) (arith (number "3"))))

=== param expansion in arithmetic
echo $((${x:-5} + 1))
---
(command (word "echo") (word "$((${x:-5} + 1))" (arith (binary-op "+" (param "x" ":-" "5") (number "1")))))

=== complex param in arithmetic
echo $((${#arr[@]} - 1))
---
(command (word "echo") (word "$((${#arr[@]} - 1))" (arith (binary-op "-" (param-len "arr[@]") (number "1")))))

=== arithmetic command pipeline
((x++)) && echo incremented
---
(list (arith-cmd (post-incr (var "x"))) (and) (command (word "echo") (word "incremented")))

=== arithmetic command or
((x > 0)) || echo "not positive"
---
(list (arith-cmd (binary-op ">" (var "x") (number "0"))) (or) (command (word "echo") (word "\"not positive\"")))

=== counter loop idiom
i=0; while ((i++ < 10)); do echo $i; done
---
(list (command (word "i=0")) (semi) (while (arith-cmd (binary-op "<" (post-incr (var "i")) (number "10"))) (command (word "echo") (word "$i" (param "i")))))

=== bounds check
((index >= 0 && index < ${#arr[@]})) && echo valid
---
(list (arith-cmd (binary-op "&&" (binary-op ">=" (var "index") (number "0")) (binary-op "<" (var "index") (param-len "arr[@]")))) (and) (command (word "echo") (word "valid")))

=== flag toggle
((flag ^= 1))
---
(arith-cmd (assign "^=" (var "flag") (number "1")))

=== power of two check
(((n & (n - 1)) == 0))
---
(arith-cmd (binary-op "==" (binary-op "&" (var "n") (binary-op "-" (var "n") (number "1"))) (number "0")))

