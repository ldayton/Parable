set shell := ["bash", "-o", "pipefail", "-cu"]

# Configuration
source := "../src/parable.py"
tests := "../tests"
dist := "../dist/go"
backends := "c go java python rust ts"
testable := "go python ts"

# Transpile source to stdout
emit backend="go":
    uv run python -m src.cli {{source}} -b {{backend}}

# Transpile source and check syntax/compilation
check backend="go":
    #!/usr/bin/env bash
    set -euo pipefail
    case "{{backend}}" in
        c)
            uv run python -m src.cli {{source}} -b c > /tmp/transpile.c
            clang -fsyntax-only /tmp/transpile.c
            ;;
        go)
            uv run python -m src.cli {{source}} -b go > /tmp/transpile-ir.go
            gofmt /tmp/transpile-ir.go > {{dist}}/parable.go
            go build -C {{dist}} -o /dev/null .
            ;;
        java)
            uv run python -m src.cli {{source}} -b java > /tmp/Output.java
            javac /tmp/Output.java -d /tmp
            ;;
        python)
            uv run python -m src.cli {{source}} -b python > /tmp/transpile.py
            ;;
        rust)
            uv run python -m src.cli {{source}} -b rust > /tmp/transpile.rs
            rustc --crate-type=lib --emit=metadata -o /tmp/transpile.rmeta /tmp/transpile.rs
            ;;
        ts)
            rm -rf /tmp/transpile-ts && mkdir -p /tmp/transpile-ts/src
            uv run python -m src.cli {{source}} -b ts > /tmp/transpile-ts/src/output.ts
            tsc --outDir /tmp/transpile-ts/src --lib es2019 --module commonjs --esModuleInterop /tmp/transpile-ts/src/output.ts
            ;;
        *)
            echo "Unknown backend: {{backend}}"
            exit 1
            ;;
    esac

# Run full parser test suite (4574 tests)
test backend="go":
    #!/usr/bin/env bash
    set -euo pipefail
    # Convert relative paths to absolute for subprocesses
    tests_abs=$(cd "$(dirname "{{tests}}")" && pwd)/$(basename "{{tests}}")
    case "{{backend}}" in
        go)
            just check go
            go run -C {{dist}} ./cmd/run-tests "$tests_abs"
            ;;
        python)
            rm -rf /tmp/transpile-test && mkdir /tmp/transpile-test
            uv run python -m src.cli {{source}} -b python > /tmp/transpile-test/parable.py
            PYTHONPATH=/tmp/transpile-test python3 {{tests}}/bin/run-tests.py {{tests}}
            ;;
        ts)
            just check ts
            node {{tests}}/bin/run-js-tests.js /tmp/transpile-ts
            ;;
        *)
            echo "No test runner for backend: {{backend}}"
            echo "Testable backends: {{testable}}"
            exit 1
            ;;
    esac

# Check all backends compile
check-all:
    #!/usr/bin/env bash
    set -euo pipefail
    for backend in {{backends}}; do
        echo "=== Checking $backend ==="
        just check "$backend" || echo "FAILED: $backend"
    done

# Run test suite on all testable backends
test-all:
    #!/usr/bin/env bash
    set -euo pipefail
    for backend in {{testable}}; do
        echo "=== Testing $backend ==="
        just test "$backend"
    done

# Show compilation errors for debugging
errors backend="go":
    @uv run python -m src.cli {{source}} -b {{backend}} > /tmp/transpile-out 2>&1 || true
    @echo "=== Transpiler output (first 20 lines) ==="
    @head -20 /tmp/transpile-out || true
    @echo "=== Compilation errors ==="
    @just check {{backend}} 2>&1 | head -50 || true

# Check style constraints on Python source
style dir="../src":
    uv run python -m src.cli --check-style "{{dir}}"
